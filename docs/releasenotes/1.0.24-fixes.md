# Galileo Glass UI v1.0.24 - PRD: Planned Fixes & Features

This document outlines the requirements for fixes, features, and updates planned for the `v1.0.24` release of the Galileo Glass UI library.

---

## 1. Fix: Application Crash Due to Incorrect Styled-Components Keyframe Interpolation

**Goal:** Resolve the critical application crash occurring when importing `@veerone/galileo-glass-ui@1.0.23` into projects using `styled-components` v4+. The crash is caused by incorrect interpolation of `keyframes` objects directly into `animation` or `animation-name` properties without the required `css` helper or `.name` property access.
**Status:** ⏳ In Progress (Code fixes complete, verification pending)
**Reference:** Bug #22 (Internal Discovery during v1.0.24 development/testing)

**Requirements:**

*   All keyframe interpolations within the `animation` shorthand property must be wrapped with the `css` helper from `styled-components`.
*   All keyframe interpolations used solely for the `animation-name` property must use the `.name` property of the keyframe object (e.g., `${myKeyframe.name}`).
*   The library must import and function correctly without causing crashes in applications using `styled-components` v4 or later.
*   Fixes must preserve the intended animation behavior and respect reduced motion settings.
*   Variable interpolations (e.g., `${animationName}`) must contain string names, not keyframe objects.

**Files Investigated/Updated:**

*   `src/animations/accessibility/AccessibleFocusAnimation.ts` (✅ Fixed - `css` helper added)
*   `src/components/GlassTabBar/styled.ts` (✅ Fixed - `.name` property used)
*   `src/animations/physics/particleSystem.ts` (✅ Fixed - `css` helper added, type signature updated)
*   `src/components/surfaces/DimensionalGlass.tsx` (✅ Fixed - `css` helper added)
*   `src/components/VisualFeedback/VisualFeedback.tsx` (✅ Fixed - `css` helper added)
*   `src/components/surfaces/FrostedGlass.tsx` (✅ Fixed - `css` helper added)
*   `src/components/MultiSelect/GlassMultiSelect.tsx` (✅ Fixed - `css` helper added)
*   `src/components/surfaces/HeatGlass.tsx` (✅ Fixed - `css` helper added)
*   `src/components/DynamicAtmosphere/DynamicAtmosphere.tsx` (✅ Fixed - `css` helper added)
*   `src/components/Loader/Loader.tsx` (✅ Fixed - `css` helper added)
*   `src/components/ImageViewer/GlassImageViewer.tsx` (✅ Fixed - `css` helper added)
*   `src/components/GlassTabs/GlassTabs.tsx` (✅ Verified - `css` helper usage appears correct, requires testing confirmation)
*   `src/components/DateRangePicker/GlassDateRangePicker.tsx` (✅ Fixed)

**Tasks:**

*   [x] Investigate root cause using `grep`, error analysis, and `styled-components` documentation.
*   [x] Apply `css` helper fix via automated edits to most identified files.
*   [x] Apply `.name` property fix via automated edits where applicable (`GlassTabBar`).
*   [x] Correct return types and nested `css` usage in `particleSystem.ts`.
*   [x] **COMPLETED:** Apply `css` helper fix to `src/components/DateRangePicker/GlassDateRangePicker.tsx` line 351 (`.preset-item`).
*   [x] **COMPLETED:** Apply `css` helper fix to `src/components/DateRangePicker/GlassDateRangePicker.tsx` line 508 (`MonthContainer`).
*   [ ] Verify fix effectiveness for `src/components/GlassTabs/GlassTabs.tsx` (ensure `slideIn` animation works and no crash occurs).
*   [ ] Add/update unit/integration tests targeting components with fixed animations.
*   [ ] Manually test importing and rendering various components in a standard Next.js/React app using `styled-components` v4+ to confirm the crash is fully resolved.
*   [ ] Update documentation if any user-facing changes were necessary (unlikely for this fix).

---

## 2. Fix: Resolve GlassTimeline Layout and Interaction Issues

**Goal:** Overhaul the layout logic of the `GlassTimeline` component to ensure stable and predictable positioning of timeline items in both vertical and horizontal orientations, resolve overlap issues, and fix interaction bugs (e.g., `goToToday` scrolling).
**Status:** ✅ Completed
**Reference:** GitHub Issue #XX (Replace with actual issue number if available) / Internal Discovery

**Summary of Changes:**

*   **Removed Absolute Positioning:** Abandoned previous attempts using complex absolute positioning calculations (`top`, `left` percentages/pixels) which were unreliable within the transformed scroll container.
*   **Implemented Nested Flexbox Layout:**
    *   `TimelineEvents` (outer container) now uses `display: flex` with appropriate `flex-direction` and `gap` for spacing.
    *   `TimelineItem` (event container) is now `position: relative` and uses `display: flex` to arrange its children.
    *   Vertical alternate alignment (`markerPosition: 'alternate'`) is handled by `margin-left: auto` / `margin-right: auto` on `TimelineItem`.
    *   `MarkerCircle`, `EventConnector`, `EventContent` are now standard flex items within `TimelineItem`, removing `position: absolute`.
    *   CSS (`flex-direction`) now primarily controls the visual order of marker, connector, and content based on orientation and side.
*   **Refactored `TimelineEvent.tsx`:** Simplified rendering logic to match the new flex structure, arranging child components conditionally based on orientation/side.
*   **Fixed `goToToday` Scroll:** Decoupled `scrollToDate` call from the `currentDate` state update by moving it into a dedicated `useEffect` hook, ensuring scrolling happens *after* the date range is recalculated.
*   **Refined Storybook:** Updated `GlassTimeline.stories.tsx` with cleaner examples and explicit marker interval settings (`markers.primaryInterval`) to improve axis readability.

**Files Investigated/Updated:**

*   `src/components/Timeline/GlassTimeline.tsx` (✅ Reworked `renderEvents`, added `useEffect` for scrolling)
*   `src/components/Timeline/styles.ts` (✅ Reworked `TimelineEvents`, `TimelineItem`, `MarkerCircle`, `EventConnector`, `EventContent` styles for flex layout)
*   `src/components/Timeline/components/TimelineEvent.tsx` (✅ Refactored rendering order)
*   `examples/components/GlassTimeline.stories.tsx` (✅ Updated examples, added `markers` prop)

**Tasks:**

*   [x] Debug and iterate through multiple failed layout strategies (absolute positioning, relative + margin).
*   [x] Identify root cause of layout instability (conflicts between absolute positioning and scroll container transform).
*   [x] Implement nested flexbox layout strategy in `styles.ts` and `TimelineEvent.tsx`.
*   [x] Remove obsolete absolute positioning logic from `GlassTimeline.tsx`.
*   [x] Diagnose and fix `goToToday` scroll bug by using `useEffect`.
*   [x] Improve Storybook examples for clarity.
*   [ ] Add specific unit/integration tests for flexbox layout and side alignment.
*   [ ] Perform thorough manual testing across different browsers and viewport sizes.

---

## 3. Fix: Resolve GlassMultiSelect Animation and State Management Issues

**Goal:** Address multiple issues in `GlassMultiSelect` component causing inconsistent behavior, performance problems, and potential application crashes including: animation implementation problems, state management inefficiencies, and incomplete feature implementations.
**Status:** ⏳ In Progress
**Reference:** Internal Discovery / Client-reported issues

**Summary of Issues:**

*   **Styled-Components Animation Issues:** Some animations may not properly use the `css` helper for keyframe interpolation, potentially causing crashes similar to Bug #22.
*   **Complex Animation System:** The component uses a multi-layered animation approach with separate entrance and exit animations, leading to potential race conditions and state inconsistencies.
*   **Token Removal Implementation Gaps:** Comment in code admits implementation challenges with keyboard-based token removal.
*   **Inefficient State Comparisons:** Uses `JSON.stringify` for comparing arrays, which is inefficient and can cause problems with complex objects.
*   **Incomplete Dependency Arrays:** Some effects and callbacks have incomplete dependency arrays, potentially leading to stale closures or missed updates.
*   **Debug Code in Production:** Contains `console.warn` statements that could spam client consoles.
*   **Portal Management Challenges:** Dropdown positioning through Portal may not always calculate coordinates correctly.

**Requirements:**

*   All keyframe interpolations must use the `css` helper from `styled-components` consistently.
*   Animation system should be simplified to avoid race conditions between animations and state updates.
*   Token addition/removal behavior must be consistent across all interaction methods (click, keyboard, programmatic).
*   State comparisons should use efficient deep equality checks rather than `JSON.stringify`.
*   All React hooks must have proper dependency arrays to prevent stale closures and ensure correct behavior.
*   Debug/development code must be removed from production builds or properly gated.
*   Dropdown positioning calculations must be robust across different rendering scenarios.

**Files Investigated/Updated:**

*   `src/components/MultiSelect/GlassMultiSelect.tsx` (❓ Inspection in progress)
*   `src/components/MultiSelect/types.ts` (❓ May need review)
*   Any related animation utility files (❓ To be determined)

**Tasks:**

*   [x] Perform comprehensive audit of animation implementations in `GlassMultiSelect` to ensure proper `css` helper usage.
*   [x] Simplify the token animation system to use a single, consistent approach for both entry and exit animations.
*   [x] Complete and standardize keyboard navigation implementation, particularly for token removal via Backspace.
*   [x] Replace `JSON.stringify` comparisons with proper deep equality checks.
*   [x] Audit and correct all dependency arrays in hooks and callbacks.
*   [x] Remove or conditionally gate debug messages (`console.warn`).
*   [x] Improve dropdown positioning logic for more reliable Portal-based rendering.
*   [x] Consider consolidating the separate token animation wrapper into the main component for better state coordination.
*   [ ] Add comprehensive tests covering token addition/removal, keyboard navigation, and dropdown positioning.
*   [ ] Verify fixes in both controlled and uncontrolled component usage scenarios.
*   [ ] Manually test in client-like environments to confirm the issues are resolved.

---

## 4. Fix/Enhancement: GlassDateRangePicker Calendar Container Styling and Visibility

**Goal:** Enhance the GlassDateRangePicker component's calendar container with improved frosted glass styling, better size dimensions, and visual contrast to improve usability and readability.
**Status:** ✅ Completed
**Reference:** Internal Discovery / Design System Audit

**Summary of Changes:**

* **Enhanced Calendar Container:** Replaced the previous basic glass styling with a more robust, visually distinctive frosted glass container.
* **Improved Container Sizing:** Increased the minimum width from 280px to 340px to fully display calendar content without clipping.
* **Added Background Overlay:** Implemented a semi-transparent background overlay to improve content contrast and visual separation from underlying content.
* **Enhanced Border Effects:** Improved border styling with stronger opacity (from 0.08 to 0.12) for greater definition.
* **Added Outer Glow Effect:** Implemented a subtle gradient glow around the container edges to enhance the glass aesthetic.
* **Improved Shadow Depth:** Increased shadow strength for better visual hierarchy (from 0.15 to 0.25).
* **Added Overflow Handling:** Added proper overflow handling to ensure clean rendering of calendar content.

**Files Investigated/Updated:**

* `src/components/DateRangePicker/GlassDateRangePicker.tsx` (✅ Enhanced `PopoverContainer` styling)

**Tasks:**

* [x] Implement improved frosted glass styling for the PopoverContainer
* [x] Increase container dimensions to better display calendar content
* [x] Add background overlay for improved content contrast
* [x] Enhance border styling for better definition
* [x] Implement outer glow effect for improved glass aesthetics
* [x] Update shadow depth for better visual hierarchy
* [ ] Add comprehensive tests for DateRangePicker rendering
* [ ] Verify changes across different viewport sizes and background colors
* [ ] Document styling changes in the component's API documentation

---

## 5. Fix/Feature: [Describe Another Issue/Feature]

**Goal:** [Describe the desired outcome.]
**Status:** 🟡 Pending
**Reference:** [Link to Bug Report/Feature Request]

**Requirements:**

*   [Requirement 1]
*   [Requirement 2]

**Files Investigated/Updated:**

*   (❓ Initial Investigation Needed)

**Tasks:** 